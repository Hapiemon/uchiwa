// This is your Prisma schema file,
// learn more about it in the docs: https://pris.ly/d/prisma-schema

generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

model User {
  id            String     @id @default(cuid())
  email         String     @unique
  name          String
  displayName   String?
  hashedPassword String
  avatarUrl     String?
  bio           String?
  timezone      String     @default("Asia/Tokyo")
  createdAt     DateTime   @default(now())
  updatedAt     DateTime   @updatedAt

  // Relations
  diaryEntries  DiaryEntry[] @relation(name: "DiaryAuthor")
  diaryEdits    DiaryEditor[]
  anniversaries Anniversary[]
  conversations ConversationParticipant[]
  messages      Message[]

  @@map("users")
}

model DiaryEntry {
  id        String   @id @default(cuid())
  authorId  String
  author    User     @relation(fields: [authorId], references: [id], onDelete: Cascade, name: "DiaryAuthor")
  title     String?
  content   String
  date      DateTime @default(now())
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
  editors   DiaryEditor[]

  @@index([authorId])
  @@index([date])
  @@map("diary_entries")
}

model DiaryEditor {
  id           String     @id @default(cuid())
  diaryEntryId String
  diaryEntry   DiaryEntry @relation(fields: [diaryEntryId], references: [id], onDelete: Cascade)
  userId       String
  user         User       @relation(fields: [userId], references: [id], onDelete: Cascade)
  editedAt     DateTime   @default(now())

  @@unique([diaryEntryId, userId])
  @@index([diaryEntryId])
  @@index([userId])
  @@map("diary_editors")
}

model Anniversary {
  id             String   @id @default(cuid())
  userId         String?
  user           User?    @relation(fields: [userId], references: [id], onDelete: Cascade)
  title          String
  date           DateTime
  repeatInterval String   @default("NONE") // NONE, WEEKLY, MONTHLY, YEARLY
  notes          String?
  createdAt      DateTime @default(now())

  @@index([userId])
  @@map("anniversaries")
}

model Conversation {
  id        String   @id @default(cuid())
  title     String?
  isDirect  Boolean  @default(true)
  createdAt DateTime @default(now())

  participants ConversationParticipant[]
  messages     Message[]

  @@map("conversations")
}

model ConversationParticipant {
  id                  String   @id @default(cuid())
  conversationId      String
  conversation        Conversation @relation(fields: [conversationId], references: [id], onDelete: Cascade)
  userId              String
  user                User     @relation(fields: [userId], references: [id], onDelete: Cascade)
  lastReadMessageId   String?
  createdAt           DateTime @default(now())

  @@unique([conversationId, userId])
  @@index([userId])
  @@map("conversation_participants")
}

model Message {
  id             String   @id @default(cuid())
  conversationId String
  conversation   Conversation @relation(fields: [conversationId], references: [id], onDelete: Cascade)
  senderId       String
  sender         User     @relation(fields: [senderId], references: [id], onDelete: Cascade)
  content        String
  readAt         DateTime?
  createdAt      DateTime @default(now())

  @@index([conversationId])
  @@index([senderId])
  @@map("messages")
}

model MemoryLink {
  id        String   @id @default(cuid())
  title     String
  url       String
  order     Int      @default(0)
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@index([order])
  @@map("memory_links")
}
